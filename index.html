<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åò„ÇÉ„Åå„Éê„Çø„ÉºÈ†ÜÁï™ÂæÖ„Å°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f7f2eb; 
            color: #4a4a4a; 
            line-height: 1.6; 
        }
        .container { 
            max-width: 600px; 
            margin: auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            text-align: center; 
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .header img {
            width: 50px;
            height: 50px;
        }
        h1 { 
            color: #925828; 
            margin: 0;
            font-size: 2.2em;
        }
        p { 
            color: #888; 
            margin-bottom: 30px; 
            font-size: 1.1em;
        }
        label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 700; 
            color: #6a6a6a; 
            font-size: 1.1em;
        }
        select { 
            width: 80%; 
            padding: 12px; 
            margin-bottom: 30px; 
            border: 1px solid #e0e0e0; 
            border-radius: 10px; 
            font-size: 1em; 
            transition: all 0.3s ease; 
            background-color: #fefefe;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        select:focus { 
            border-color: #ff914d; 
            outline: none; 
            box-shadow: 0 0 8px rgba(255,145,77,0.3);
        }
        .button { 
            width: 80%; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            background-color: #ff914d; 
            color: white; 
            font-size: 1.2em; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: 700; 
            box-shadow: 0 4px 15px rgba(255,145,77,0.4);
        }
        .button:hover { 
            background-color: #ff7f33; 
            transform: translateY(-3px); 
            box-shadow: 0 6px 20px rgba(255,145,77,0.5);
        }
        .button:active { 
            transform: translateY(0); 
            box-shadow: 0 2px 10px rgba(255,145,77,0.4);
        }
        .button.cancel-btn { 
            background-color: #e76f51; 
            margin-top: 15px; 
            box-shadow: 0 4px 15px rgba(231,111,81,0.4);
        }
        .button.cancel-btn:hover { 
            background-color: #d65535;
        }
        .button.reload-btn { 
            background-color: #c9c9c9; 
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(201,201,201,0.4);
        }
        .button.reload-btn:hover { 
            background-color: #adadad; 
        }
        .loading-text { 
            color: #ff914d; 
            margin-top: 20px; 
            font-size: 1.1em; 
            display: none; 
        }
        .reservation-info { 
            margin-top: 35px; 
            border-top: 2px solid #f0e6da; 
            padding-top: 30px; 
        }
        .reservation-info h2 { 
            color: #6a6a6a; 
            margin-bottom: 25px; 
        }
        .info-item { 
            font-size: 1.1em; 
            margin-bottom: 15px; 
            text-align: left; 
            background-color: #fff8ee; 
            padding: 20px; 
            border-radius: 12px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #f0e6da;
        }
        .info-item strong { 
            color: #925828; 
            font-weight: 700;
        }
        .status-message { 
            font-size: 1.3em; 
            color: #ff7f33; 
            font-weight: 700; 
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://em-content.zobj.net/source/microsoft-teams/337/potato_1f954.png" alt="„Åò„ÇÉ„Åå„ÅÑ„ÇÇ„Ç¢„Ç§„Ç≥„É≥">
        <h1>3Âπ¥3ÁµÑ „Åò„ÇÉ„Åå„Éê„Çø„ÉºË≤©Â£≤</h1>
    </div>
    <p>‰∫∫Êï∞„ÇíÈÅ∏„Çì„Åß‰∫àÁ¥Ñ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÊúÄÂ§ß3Âêç„Åæ„ÅßÔºâ</p>

    <div id="reservation-form">
        <label for="people">‰∫àÁ¥Ñ‰∫∫Êï∞Ôºö</label>
        <select id="people">
            <option value="1">1‰∫∫</option>
            <option value="2">2‰∫∫</option>
            <option value="3">3‰∫∫</option>
        </select>
        <button id="reserve-btn" class="button">‰∫àÁ¥Ñ„Åô„Çã</button>
        <div id="loading-message" class="loading-text">‰∫àÁ¥ÑÂá¶ÁêÜ‰∏≠...</div>
    </div>

    <div id="reservation-info" class="reservation-info" style="display:none;">
        <div class="status-message">‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ</div>
        <h2>„ÅÇ„Å™„Åü„ÅÆ‰∫àÁ¥ÑÊÉÖÂ†±</h2>
        <div class="info-item"><strong>Âèó‰ªòÁï™Âè∑:</strong> <span id="my-reservation-number"></span></div>
        <div class="info-item"><strong>ÁèæÂú®„ÅÆÂæÖ„Å°‰∫∫Êï∞:</strong> <span id="my-waiting-count"></span>ÁµÑ</div>
        <div class="info-item"><strong>„Åä„Åä„Çà„Åù„ÅÆÂæÖ„Å°ÊôÇÈñì:</strong> <span id="my-waiting-time"></span></div>
        <button id="reload-btn" class="button reload-btn">üîÑ Êõ¥Êñ∞</button>
        <button class="button cancel-btn" id="cancel-my-reservation-btn">‰∫àÁ¥Ñ„Çí„Ç≠„É£„É≥„Çª„É´„Åô„Çã</button>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBauC4hh30fZphPsYpH9tbWscvJ7Lf2GeT4u5ofLvIOWAGxE70O6QKmmuey2htKYIu/exec';
    const SPECIAL_WAIT_TIME = 30;

    let myReservationNumber = null;
    let reservationTimestamp = null;

    window.onload = function() {
        const storedNumber = localStorage.getItem('myReservationNumber');
        const storedTimestamp = localStorage.getItem('reservationTimestamp');

        if (storedNumber && storedTimestamp) {
            myReservationNumber = parseInt(storedNumber);
            reservationTimestamp = parseInt(storedTimestamp);
            document.getElementById('reservation-form').style.display = 'none';
            document.getElementById('reservation-info').style.display = 'block';
            updateDisplay();
        }
        setInterval(updateDisplay, 5000);
    };

    document.getElementById('reserve-btn').addEventListener('click', function() {
        const reserveBtn = this;
        reserveBtn.disabled = true;
        document.getElementById('loading-message').style.display = 'block';

        const people = document.getElementById('people').value;
        const formData = new FormData();
        formData.append('action', 'reserve');
        formData.append('people', people);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData,
        }).then(async () => {
            setTimeout(async () => {
                const reservationResponse = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: new URLSearchParams({ action: 'getReservations' }),
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                });
                const reservationData = await reservationResponse.json();
                if (reservationData.success) {
                    const lastReservation = reservationData.reservations[reservationData.reservations.length - 1];
                    if (lastReservation) {
                        myReservationNumber = lastReservation.reservationNumber;
                        reservationTimestamp = new Date().getTime();
                        localStorage.setItem('myReservationNumber', myReservationNumber);
                        localStorage.setItem('reservationTimestamp', reservationTimestamp);
                        document.getElementById('reservation-form').style.display = 'none';
                        document.getElementById('reservation-info').style.display = 'block';
                        updateDisplay();
                    }
                }
                reserveBtn.disabled = false;
                document.getElementById('loading-message').style.display = 'none';
            }, 3000);
        }).catch(error => {
            console.error('‰∫àÁ¥Ñ„Ç®„É©„Éº:', error);
            alert('‰∫àÁ¥Ñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            reserveBtn.disabled = false;
            document.getElementById('loading-message').style.display = 'none';
        });
    });

    document.getElementById('reload-btn').addEventListener('click', updateDisplay);

    async function updateDisplay() {
        try {
            const reservationResponse = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ action: 'getReservations' }),
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            });
            const reservationData = await reservationResponse.json();

            if (reservationData.success) {
                const reservations = reservationData.reservations;
                
                if (myReservationNumber) {
                    const myIndex = reservations.findIndex(r => r.reservationNumber === myReservationNumber);
                    if (myIndex !== -1) {
                        const waitingCount = myIndex;
                        let baseWaitTime;

                        if (waitingCount <= 19) {
                            baseWaitTime = 15;
                        } else {
                            baseWaitTime = SPECIAL_WAIT_TIME;
                        }

                        // ÁµåÈÅéÊôÇÈñìÔºàÂàÜÔºâ„ÇíË®àÁÆó
                        const elapsedTime = Math.floor((new Date().getTime() - reservationTimestamp) / 60000);
                        const currentWaitTime = Math.max(0, baseWaitTime - elapsedTime);

                        document.getElementById('my-reservation-number').textContent = myReservationNumber;
                        document.getElementById('my-waiting-count').textContent = waitingCount;
                        document.getElementById('my-waiting-time').textContent = `${currentWaitTime}ÂàÜ`;
                    } else {
                        alert('‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                        clearMyReservation();
                    }
                }
            }
        } catch (error) {
            console.error('Ë°®Á§∫Êõ¥Êñ∞„Ç®„É©„Éº:', error);
        }
    }

    document.getElementById('cancel-my-reservation-btn').addEventListener('click', function() {
        if (!confirm('Êú¨ÂΩì„Å´‰∫àÁ¥Ñ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô„ÅãÔºü')) {
            return;
        }

        const formData = new FormData();
        formData.append('action', 'cancelReservation');
        formData.append('reservationNumber', myReservationNumber);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData,
        }).then(() => {
            alert('‰∫àÁ¥Ñ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ');
            clearMyReservation();
        }).catch(error => {
            console.error('„Ç≠„É£„É≥„Çª„É´„Ç®„É©„Éº:', error);
            alert('„Ç≠„É£„É≥„Çª„É´„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
        });
    });

    function clearMyReservation() {
        localStorage.removeItem('myReservationNumber');
        localStorage.removeItem('reservationTimestamp');
        myReservationNumber = null;
        reservationTimestamp = null;
        document.getElementById('reservation-form').style.display = 'block';
        document.getElementById('reservation-info').style.display = 'none';
    }
</script>

</body>
</html>
