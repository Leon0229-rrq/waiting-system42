<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã˜ã‚ƒãŒãƒã‚¿ãƒ¼é †ç•ªå¾…ã¡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f7f2eb; 
            color: #4a4a4a; 
            line-height: 1.6; 
        }
        .container { 
            max-width: 600px; 
            margin: auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            text-align: center; 
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .header img {
            width: 50px;
            height: 50px;
        }
        h1 { 
            color: #925828; 
            margin: 0;
            font-size: 2.2em;
        }
        p { 
            color: #888; 
            margin-bottom: 30px; 
            font-size: 1.1em;
        }
        label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 700; 
            color: #6a6a6a; 
            font-size: 1.1em;
        }
        select { 
            width: 80%; 
            padding: 12px; 
            margin-bottom: 30px; 
            border: 1px solid #e0e0e0; 
            border-radius: 10px; 
            font-size: 1em; 
            transition: all 0.3s ease; 
            background-color: #fefefe;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        }
        select:focus { 
            border-color: #ff914d; 
            outline: none; 
            box-shadow: 0 0 8px rgba(255,145,77,0.3);
        }
        .button { 
            width: 80%; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            background-color: #ff914d; 
            color: white; 
            font-size: 1.2em; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: 700; 
            box-shadow: 0 4px 15px rgba(255,145,77,0.4);
        }
        .button:hover { 
            background-color: #ff7f33; 
            transform: translateY(-3px); 
            box-shadow: 0 6px 20px rgba(255,145,77,0.5);
        }
        .button:active { 
            transform: translateY(0); 
            box-shadow: 0 2px 10px rgba(255,145,77,0.4);
        }
        .button.cancel-btn { 
            background-color: #e76f51; 
            margin-top: 15px; 
            box-shadow: 0 4px 15px rgba(231,111,81,0.4);
        }
        .button.cancel-btn:hover { 
            background-color: #d65535;
        }
        .button.reload-btn { 
            background-color: #c9c9c9; 
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(201,201,201,0.4);
        }
        .button.reload-btn:hover { 
            background-color: #adadad; 
        }
        .loading-text { 
            color: #ff914d; 
            margin-top: 20px; 
            font-size: 1.1em; 
            display: none; 
        }
        .reservation-info { 
            margin-top: 35px; 
            border-top: 2px solid #f0e6da; 
            padding-top: 30px; 
        }
        .reservation-info h2 { 
            color: #6a6a6a; 
            margin-bottom: 25px; 
        }
        .info-item { 
            font-size: 1.1em; 
            margin-bottom: 15px; 
            text-align: left; 
            background-color: #fff8ee; 
            padding: 20px; 
            border-radius: 12px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #f0e6da;
        }
        .info-item strong { 
            color: #925828; 
            font-weight: 700;
        }
        .status-message { 
            font-size: 1.3em; 
            color: #ff7f33; 
            font-weight: 700; 
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://em-content.zobj.net/source/microsoft-teams/337/potato_1f954.png" alt="ã˜ã‚ƒãŒã„ã‚‚ã‚¢ã‚¤ã‚³ãƒ³">
        <h1>3å¹´3çµ„ ã˜ã‚ƒãŒãƒã‚¿ãƒ¼è²©å£²</h1>
    </div>
    <p>äººæ•°ã‚’é¸ã‚“ã§äºˆç´„ã—ã¦ãã ã•ã„ï¼ˆæœ€å¤§3åã¾ã§ï¼‰</p>

    <div id="reservation-form">
        <label for="people">äºˆç´„äººæ•°ï¼š</label>
        <select id="people">
            <option value="1">1äºº</option>
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
        </select>
        <button id="reserve-btn" class="button">äºˆç´„ã™ã‚‹</button>
        <div id="loading-message" class="loading-text">äºˆç´„å‡¦ç†ä¸­...</div>
    </div>

    <div id="reservation-info" class="reservation-info" style="display:none;">
        <div class="status-message">äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>
        <h2>ã‚ãªãŸã®äºˆç´„æƒ…å ±</h2>
        <div class="info-item"><strong>å—ä»˜ç•ªå·:</strong> <span id="my-reservation-number"></span></div>
        <div class="info-item"><strong>ç¾åœ¨ã®å¾…ã¡äººæ•°:</strong> <span id="my-waiting-count"></span>çµ„</div>
        <div class="info-item"><strong>ãŠãŠã‚ˆãã®å¾…ã¡æ™‚é–“:</strong> <span id="my-waiting-time"></span></div>
        <button id="reload-btn" class="button reload-btn">ğŸ”„ æ›´æ–°</button>
        <button class="button cancel-btn" id="cancel-my-reservation-btn">äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</button>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBauC4hh30fZphPsYpH9tbWscvJ7Lf2GeT4u5ofLvIOWAGxE70O6QKmmuey2htKYIu/exec';
    const SPECIAL_WAIT_TIME = 30;

    let myReservationNumber = null;
    let reservationTimestamp = null;

    window.onload = function() {
        const storedNumber = localStorage.getItem('myReservationNumber');
        const storedTimestamp = localStorage.getItem('reservationTimestamp');

        if (storedNumber && storedTimestamp) {
            myReservationNumber = parseInt(storedNumber);
            reservationTimestamp = parseInt(storedTimestamp);
            document.getElementById('reservation-form').style.display = 'none';
            document.getElementById('reservation-info').style.display = 'block';
            updateDisplay();
        }
        setInterval(updateDisplay, 5000);
    };

    document.getElementById('reserve-btn').addEventListener('click', function() {
        const reserveBtn = this;
        reserveBtn.disabled = true;
        document.getElementById('loading-message').style.display = 'block';

        const people = document.getElementById('people').value;
        const formData = new FormData();
        formData.append('action', 'reserve');
        formData.append('people', people);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData,
        }).then(async () => {
            setTimeout(async () => {
                const reservationResponse = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: new URLSearchParams({ action: 'getReservations' }),
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                });
                const reservationData = await reservationResponse.json();
                if (reservationData.success) {
                    const lastReservation = reservationData.reservations[reservationData.reservations.length - 1];
                    if (lastReservation) {
                        myReservationNumber = lastReservation.reservationNumber;
                        reservationTimestamp = new Date().getTime();
                        localStorage.setItem('myReservationNumber', myReservationNumber);
                        localStorage.setItem('reservationTimestamp', reservationTimestamp);
                        document.getElementById('reservation-form').style.display = 'none';
                        document.getElementById('reservation-info').style.display = 'block';
                        updateDisplay();
                    }
                }
                reserveBtn.disabled = false;
                document.getElementById('loading-message').style.display = 'none';
            }, 3000);
        }).catch(error => {
            console.error('äºˆç´„ã‚¨ãƒ©ãƒ¼:', error);
            alert('äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            reserveBtn.disabled = false;
            document.getElementById('loading-message').style.display = 'none';
        });
    });

    document.getElementById('reload-btn').addEventListener('click', updateDisplay);

    async function updateDisplay() {
        try {
            const reservationResponse = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ action: 'getReservations' }),
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            });
            const reservationData = await reservationResponse.json();

            if (reservationData.success) {
                const reservations = reservationData.reservations;
                
                if (myReservationNumber) {
                    const myIndex = reservations.findIndex(r => r.reservationNumber === myReservationNumber);
                    if (myIndex !== -1) {
                        const waitingCount = myIndex;
                        let baseWaitTime;

                        if (waitingCount <= 19) {
                            baseWaitTime = 15;
                        } else {
                            baseWaitTime = SPECIAL_WAIT_TIME;
                        }

                        // çµŒéæ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’è¨ˆç®—
                        const elapsedTime = Math.floor((new Date().getTime() - reservationTimestamp) / 60000);
                        const currentWaitTime = Math.max(0, baseWaitTime - elapsedTime);

                        document.getElementById('my-reservation-number').textContent = myReservationNumber;
                        document.getElementById('my-waiting-count').textContent = waitingCount;
                        document.getElementById('my-waiting-time').textContent = `${currentWaitTime}åˆ†`;
                    } else {
                        alert('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                        clearMyReservation();
                    }
                }
            }
        } catch (error) {
            console.error('è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    document.getElementById('cancel-my-reservation-btn').addEventListener('click', function() {
        if (!confirm('æœ¬å½“ã«äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
            return;
        }

        const formData = new FormData();
        formData.append('action', 'cancelReservation');
        formData.append('reservationNumber', myReservationNumber);

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: formData,
        }).then(() => {
            alert('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
            clearMyReservation();
        }).catch(error => {
            console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
            alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        });
    });

    function clearMyReservation() {
        localStorage.removeItem('myReservationNumber');
        localStorage.removeItem('reservationTimestamp');
        myReservationNumber = null;
        reservationTimestamp = null;
        document.getElementById('reservation-form').style.display = 'block';
        document.getElementById('reservation-info').style.display = 'none';
    }
</script>

</body>
</html>
